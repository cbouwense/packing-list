<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Gotta pack</title>
  <link rel="stylesheet" href="main.css">
</head>

<body>
  <main>
    <ul id="packing-list">
      <!-- items will be added here -->
    </ul>
    <div>
      <input type="checkbox" id="all-packed" name="all-packed" value="all-packed" onclick="checkOrUncheckAll('packed')">
      <label for="all-packed">All packed</label>
    </div>
    <div>
      <input type="checkbox" id="all-staged" name="all-staged" value="all-staged" onclick="checkOrUncheckAll('staged')">
      <label for="all-staged">All staged</label>
    </div>
    <div>
      <input type="checkbox" id="all-in-car" name="all-in-car" value="all-in-car" onclick="checkOrUncheckAll('car')">
      <label for="all-in-car">All in car</label>
    </div>
    <input type="text" id="new-item" name="new-item" value="" />
    <button onclick="addNewItem()">add</button>
    <button onclick="reset()">reset</button>
  </main>

  <script>
    /**
     * @param elem {EventTarget}
     * @returns {void}
     */
    function updateCheckedState(elem) {
      if (elem) {
        const [item, state] = elem.id.split('-');
        console.log(item, state)
        // replace all underscores with spaces
        const itemName = item.replace(/_/g, ' ');

        const oldLocalStorage = JSON.parse(localStorage.getItem('gottapack'));

        let newState = '';
        switch (state) {
          case 'packed':
            newState = elem.checked ? 'packed' : '';
            document.getElementById(`${item}-staged`).checked = false;
            document.getElementById(`${item}-car`).checked = false;
            break;
          case 'staged':
            newState = elem.checked ? 'staged' : 'packed';
            document.getElementById(`${item}-packed`).checked = true;
            document.getElementById(`${item}-car`).checked = false;
            break;
          case 'car':
            newState = elem.checked ? 'car' : 'staged';
            document.getElementById(`${item}-packed`).checked = true;
            document.getElementById(`${item}-staged`).checked = true;
            break;
        }

        localStorage.setItem(
          'gottapack',
          JSON.stringify({ ...oldLocalStorage, [itemName]: newState })
        );
      }

      const checkboxes = document.getElementById('packing-list').querySelectorAll('input[type="checkbox"]');
      const packedCheckboxes = [...checkboxes].filter(checkbox => checkbox.id.includes('packed'));
      const stagedCheckboxes = [...checkboxes].filter(checkbox => checkbox.id.includes('staged'));
      const carCheckboxes = [...checkboxes].filter(checkbox => checkbox.id.includes('car'));

      const allPackedChecked = [...packedCheckboxes].every(checkbox => checkbox.checked);
      document.getElementById('all-packed').checked = allPackedChecked;

      const allStagedChecked = [...stagedCheckboxes].every(checkbox => checkbox.checked);
      document.getElementById('all-staged').checked = allStagedChecked;

      const allCarChecked = [...carCheckboxes].every(checkbox => checkbox.checked);
      document.getElementById('all-in-car').checked = allCarChecked;
    }

    /**
     * @param state {string} 'packed', 'staged', 'car'
     * @returns {void}
     */
    function checkOrUncheckAll(state) {
      const checkboxes = document.getElementById('packing-list').querySelectorAll('input[type="checkbox"]');
      const packedCheckboxes = [...checkboxes].filter(checkbox => checkbox.id.includes('packed'));
      const stagedCheckboxes = [...checkboxes].filter(checkbox => checkbox.id.includes('staged'));
      const carCheckboxes = [...checkboxes].filter(checkbox => checkbox.id.includes('car'));
      const relevantCheckboxes = state === 'packed' ? packedCheckboxes : (state === 'staged' ? stagedCheckboxes : carCheckboxes);

      const allChecked = [...relevantCheckboxes].every(checkbox => checkbox.checked);
      const someAreChecked = [...relevantCheckboxes].some(checkbox => checkbox.checked);
      const noneAreChecked = !someAreChecked;

      // if all are checked, uncheck all, and vice versa
      const oldLocalStorage = JSON.parse(localStorage.getItem('gottapack'));
      let newLocalStorage = {};
      switch (state) {
        case 'packed':
          if (allChecked) { // uncheck all
            [...relevantCheckboxes].forEach(checkbox => checkbox.checked = false);
            Object.entries(oldLocalStorage).forEach(([key, value]) => { newLocalStorage[key] = '' });
          } else { // check all
            [...relevantCheckboxes].forEach(checkbox => checkbox.checked = true);
            Object.entries(oldLocalStorage).forEach(([key, value]) => { newLocalStorage[key] = 'packed' });
          }
          stagedCheckboxes.forEach(checkbox => checkbox.checked = false);
          carCheckboxes.forEach(checkbox => checkbox.checked = false);

          break;
        case 'staged':
          if (allChecked) {
            [...relevantCheckboxes].forEach(checkbox => checkbox.checked = false);
            Object.entries(oldLocalStorage).forEach(([key, value]) => { newLocalStorage[key] = 'packed' });
          } else {
            [...relevantCheckboxes].forEach(checkbox => checkbox.checked = true);
            Object.entries(oldLocalStorage).forEach(([key, value]) => { newLocalStorage[key] = 'staged' });
          }
          packedCheckboxes.forEach(checkbox => checkbox.checked = true);
          carCheckboxes.forEach(checkbox => checkbox.checked = false);
          break;
        case 'car':
          if (allChecked) {
            [...relevantCheckboxes].forEach(checkbox => checkbox.checked = false);
            Object.entries(oldLocalStorage).forEach(([key, value]) => { newLocalStorage[key] = 'staged' });
          } else {
            [...relevantCheckboxes].forEach(checkbox => checkbox.checked = true);
            Object.entries(oldLocalStorage).forEach(([key, value]) => { newLocalStorage[key] = 'car' });
          }
          packedCheckboxes.forEach(checkbox => checkbox.checked = true);
          stagedCheckboxes.forEach(checkbox => checkbox.checked = true);
          break;
      }

      localStorage.setItem('gottapack', JSON.stringify(newLocalStorage));

      updateCheckedState();
    }

    function generateCheckboxItem(itemName, isPacked, isStaged, isInCar) {
      const itemNameWithoutSpaces = itemName.replace(/ /g, '_');

      const li = document.createElement('li');

      const checkbox1 = document.createElement('input');
      checkbox1.type = 'checkbox';
      checkbox1.id = itemNameWithoutSpaces + '-packed';
      checkbox1.onclick = function () { updateCheckedState(this); };
      if (isPacked) checkbox1.checked = true;
      if (isStaged) checkbox1.checked = true;
      if (isInCar) checkbox1.checked = true;

      const checkbox2 = document.createElement('input');
      checkbox2.type = 'checkbox';
      checkbox2.id = itemNameWithoutSpaces + '-staged';
      checkbox2.onclick = function () { updateCheckedState(this); };
      if (isStaged) checkbox2.checked = true;
      if (isInCar) checkbox2.checked = true;

      const checkbox3 = document.createElement('input');
      checkbox3.type = 'checkbox';
      checkbox3.id = itemNameWithoutSpaces + '-car';
      checkbox3.onclick = function () { updateCheckedState(this); };
      if (isInCar) checkbox3.checked = true;

      const span = document.createElement('span');
      span.textContent = itemName;

      const button = document.createElement('button');
      button.textContent = 'delete';
      button.onclick = function () { deleteItem(this); };

      const checkboxDiv = document.createElement('div');

      checkboxDiv.appendChild(checkbox1);
      checkboxDiv.appendChild(checkbox2);
      checkboxDiv.appendChild(checkbox3);
      checkboxDiv.appendChild(span);
      li.appendChild(checkboxDiv);
      li.appendChild(button);

      document.getElementById('packing-list').appendChild(li);
    }

    function addNewItem() {
      const itemName = document.getElementById('new-item').value;
      if (!itemName) return;
      // If item already exists, do nothing
      if (document.getElementById(itemName.replace(/ /g, '_') + '-packed')) return;
      if (document.getElementById(itemName.replace(/ /g, '_') + '-staged')) return;
      if (document.getElementById(itemName.replace(/ /g, '_') + '-car')) return;

      generateCheckboxItem(itemName);
      document.getElementById('new-item').value = '';

      const oldLocalStorage = JSON.parse(localStorage.getItem('gottapack'));
      const newLocalStorage = { ...oldLocalStorage, [itemName]: '' };
      localStorage.setItem('gottapack', JSON.stringify(newLocalStorage));

      updateCheckedState();
    }

    function deleteItem(item) {
      const itemName = item.parentElement.querySelector('span').textContent;
      document.getElementById(itemName.replace(/ /g, '_') + '-packed').checked = false;
      document.getElementById(itemName.replace(/ /g, '_') + '-staged').checked = false;
      document.getElementById(itemName.replace(/ /g, '_') + '-car').checked = false;
      item.parentElement.remove();

      const oldLocalStorage = JSON.parse(localStorage.getItem('gottapack'));
      const newLocalStorage = { ...oldLocalStorage };
      delete newLocalStorage[itemName];
      localStorage.setItem('gottapack', JSON.stringify(newLocalStorage));

      updateCheckedState();
    }

    function reset() {
      localStorage.removeItem('gottapack');
      location.reload();
    }

    // Of the form
    // "gottapack": {
    //   "brush":  "packed",
    //   "phone":  "staged",
    //   "wallet": "car"
    // };
    const storedItems = localStorage.getItem('gottapack');
    if (storedItems) {
      const itemNames = [];
      const items = JSON.parse(storedItems);
      Object.entries(items).forEach(([itemName, state]) => {
        itemNames.push(itemName);
        generateCheckboxItem(
          itemName,
          state === 'packed',
          state === 'staged',
          state === 'car'
        );
      });
    } else {
      const freshLocalState = {};
      const defaultItems = [
        'pkw',
        'sunglasses',
        'glasses',
        'ear buds',
        'phone charger',
        'eye mask',
        'ear plugs',
        'inhaler',
        'clothes',
        'toiletries',
        'water bottle',
        'books',
        'lumbar pad',
        'lumbar towel',
        'sandals',
      ];
      defaultItems.forEach(item => {
        generateCheckboxItem(item);
        freshLocalState[item] = '';
      });

      localStorage.setItem('gottapack', JSON.stringify(freshLocalState));
    }

    // Do once on page load
    updateCheckedState();

    const currentPath = window.location.pathname;
    const filename = currentPath.split('/').pop().split('.')[0];
    console.log(currentPath, filename);
  </script>
</body>

</html>